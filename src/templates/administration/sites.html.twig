{% extends 'administration/admin.html.twig' %}

{% block admin_content %}

    {% include 'administration/siteCreate.html.twig' %}
    <div class="card mb-3" id="siteList">
        <div class="card-header border-light bg-white text-right">
            <div class="row">
                <div class="col-auto mr-auto mt-2">
                    <form id="projectForm" class="form-inline" action="{{ baseUrl }}/admin/sites">
                        <label for="projectId">Project</label>
                        <select id="projectId" name="projectId" class="form-control form-control-sm ml-3">
                            {% for project in projects %}
                                <option value="{{ project.id }}" {{ project.id == projectId ? 'selected' }}>
                                    {{ project.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <label for="collectionId" class="ml-3">Collection</label>
                        <select id="collectionId" name="collectionId" class="form-control form-control-sm ml-3">
                            <option></option>
                            {% for collection in collections %}
                                <option value="{{ collection.id }}" {{ collection.id == collectionId ? 'selected' }}>
                                    {{ collection.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
                <button id="siteFormButton" class="btn btn-outline-primary btn-sm mt-2" type="button" data-toggle="collapse" data-target="#siteFormSection" aria-expanded="false" aria-controls="siteFormSection">
                    <i class="fas fa-plus"></i>
                    Add Site
                </button>
            </div>
        </div>
        <table id="siteTable" style="display:none;white-space: nowrap;">
            <thead class="table-borderless">
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Longitude</th>
                <th>Latitude</th>
                <th>Topography</th>
                <th>Freshwater Depth</th>
                <th>GADM 0</th>
                <th>GADM 1</th>
                <th>GADM 2</th>
                <th>Realm</th>
                <th>Biome</th>
                <th>Functional Type</th>
                {% if isManage %}
                    <th></th>
                {% endif %}
                <th></th>
            </tr>
            </thead>
            <tbody class="form-control-sm js-site-list">
            </tbody>
        </table>
    </div>
{% endblock %}

{% block header %}
    {{ parent() }}

    <script>
        $(function () {
            var arr ={{ iucn_gets|json_encode|raw }};
            $(document).ready(function () {
                $('#siteTable').show()
                $('#siteTable').DataTable({
                    "processing": true,
                    "serverSide": true,
                    "ajax": {
                        "url": '{{ baseUrl }}/admin/siteManager/getListByPage/{{ projectId }}/{{ collectionId }}',
                        "type": 'POST'
                    },
                    "pageLength": 8,
                    "stateSave": true,
                    "lengthChange": false,
                    "StateDuration": -1,
                    "order": [[0, 'asc']],
                    "columnDefs": [{
                        "orderable": false,
                        "targets": [12, 13]
                    }],
                    "bAutoWidth": false,
                    "scrollX": true,
                });
                'use strict';

                $('#realm').on('change', function () {
                    $("#biome").empty()
                    $("#biome").append("<option></option>");
                    $("#biome").attr('disabled', false)
                    $("#functionalType").empty()
                    $("#functionalType").append("<option></option>");
                    $("#functionalType").attr('disabled', true)
                    var biomes = arr['pid' + $(this).val()]
                    if (typeof (biomes) == 'undefined') {
                        $("#biome").attr('disabled', true)
                    }
                    for (var key in biomes) {
                        $("#biome").append("<option value=" + biomes[key][0] + ">" + biomes[key][1] + "</option>");
                    }
                });
                $("#biome").on('change', function () {
                    $("#functionalType").empty()
                    $("#functionalType").append("<option></option>");
                    $("#functionalType").attr('disabled', false)
                    var functionalTypes = arr['pid' + $(this).val()]
                    if (typeof (functionalTypes) == 'undefined') {
                        $("#functionalType").attr('disabled', true)
                    }
                    for (var key in functionalTypes) {
                        $("#functionalType").append("<option value=" + functionalTypes[key][0] + ">" + functionalTypes[key][1] + "</option>");
                    }
                });
                $("#gadm0").on('change', function () {
                    $("#gadm1").empty()
                    $("#gadm2").empty()
                    $("#gadm1").append("<option></option>");
                    $("#gadm2").append("<option></option>");
                    $("#gadm1").attr('disabled', true)
                    $("#gadm2").attr('disabled', true)
                    $.ajax({
                        url: "{{ baseUrl }}/admin/siteManager/gadm/1/" + $(this).val(),
                        success: function (data) {
                            if (data == '[]') {
                                $("#gadm1").attr('disabled', true)
                                $("#gadm2").attr('disabled', true)
                            } else if (typeof (data) != 'undefined') {
                                $("#gadm1").attr('disabled', false)
                                data = JSON.parse(data)
                                for (var key in data) {
                                    $("#gadm1").append("<option value=" + data[key]['name'] + ">" + data[key]['name'] + "</option>");
                                }
                            }
                        },
                    })
                });
                $("#gadm1").on('change', function () {
                    $("#gadm2").empty()
                    $("#gadm2").append("<option></option>");
                    $("#gadm2").attr('disabled', true)
                    $.ajax({
                        url: "{{ baseUrl }}/admin/siteManager/gadm/2/" + $(this).val(),
                        success: function (data) {
                            if (data == '[]') {
                                $("#gadm2").attr('disabled', true)
                            } else if (typeof (data) != 'undefined') {
                                $("#gadm2").attr('disabled', false)
                                data = JSON.parse(data)
                                for (var key in data) {
                                    $("#gadm2").append("<option value=" + data[key]['name'] + ">" + data[key]['name'] + "</option>");
                                }
                            }
                        },
                    })
                });
                $('#longitude').on('change', function () {
                    if (this.checkValidity() === false) {
                        if ($('#invalid LatDiv').css('display') && $('#inv4LatDiv').css('display')) {
                            $('#inv4LatDiv').css({"width": "", "display": ""});
                        }
                        $('#invalidLongDiv').css({"width": "50%", "display": "inline-block", "position": "relative"});
                    } else {
                        if ($('#invalidLatDiv').css('display') && (!$('#inv4LatDiv').css('display') || $('#inv4LatDiv').css('display') === 'none')) {
                            $('#inv4LatDiv').css({"width": "50%", "display": "inline-block"});
                        }
                        if ((!$('#invalidLatDiv').css('display') || $('#invalidLatDiv').css('display') === 'none') || !$('#inv4LatDiv').css('display')) {
                            $('#inv4LatDiv').css({"width": "", "display": ""});
                        }

                        $('#invalidLongDiv').css({"display": "", "position": ""});
                    }
                });
                $('#latitude').on('change', function () {
                    if (this.checkValidity() === false) {
                        $('#inv4LatDiv').css({"width": "50%", "display": "inline-block"});
                        $('#invalidLatDiv').css({
                            "width": "49%",
                            "display": "inline-block",
                            "position": "relative",
                            "right": "2"
                        });
                    } else {
                        $('#invalidLatDiv').css({"display": "", "position": ""});
                        $('#inv4LatDiv').css({"width": "", "display": ""});
                    }
                });
                $('#topography_m').on('change', function () {
                    if (this.checkValidity() === false) {
                        if ($('#invalidFreshwaterDepthDiv').css('display') && $('#inv4FreshwaterDepthDiv').css('display')) {
                            $('#inv4FreshwaterDepthDiv').css({"width": "", "display": ""});
                        }
                        $('#invalidTopographyDiv').css({"width": "50%", "display": "inline-block", "position": "relative"});
                    } else {
                        if ($('#invalidFreshwaterDepthDiv').css('display') && (!$('#inv4FreshwaterDepthDiv').css('display') || $('#inv4FreshwaterDepthDiv').css('display') === 'none')) {
                            $('#inv4FreshwaterDepthDiv').css({"width": "50%", "display": "inline-block"});
                        }
                        if ((!$('#invalidFreshwaterDepthDiv').css('display') || $('#invalidFreshwaterDepthDiv').css('display') === 'none') || !$('#inv4FreshwaterDepthDiv').css('display')) {
                            $('#inv4FreshwaterDepthDiv').css({"width": "", "display": ""});
                        }

                        $('#invalidTopographyDiv').css({"display": "", "position": ""});
                    }
                });
                $('#freshwater_depth_m').on('change', function () {
                    if (this.checkValidity() === false) {
                        $('#inv4FreshwaterDepthDiv').css({"width": "50%", "display": "inline-block"});
                        $('#invalidFreshwaterDepthDiv').css({
                            "width": "49%",
                            "display": "inline-block",
                            "position": "relative",
                            "right": "2"
                        });
                    } else {
                        $('#invalidFreshwaterDepthDiv').css({"display": "", "position": ""});
                        $('#inv4FreshwaterDepthDiv').css({"width": "", "display": ""});
                    }
                });
                //datatable
                $('#siteTable tbody').on('change', "select[name='realm_id']", function () {
                    var id = $(this).attr('id').split('_')[1]
                    $("#biome_" + id).empty()
                    $("#biome_" + id).append("<option></option>");
                    $("#biome_" + id).attr('disabled', true)
                    $("#functionalType_" + id).empty()
                    $("#functionalType_" + id).append("<option></option>");
                    $("#functionalType_" + id).attr('disabled', true)
                    var biomes = arr['pid' + $(this).val()]
                    if (typeof (biomes) != 'undefined') {
                        $("#biome_" + id).attr('disabled', false)
                    }
                    for (var key in biomes) {
                        $("#biome_" + id).append("<option value=" + biomes[key][0] + ">" + biomes[key][1] + "</option>");
                    }
                });
                $('#siteTable tbody').on('change', "select[name='biome_id']", function () {
                    var id = $(this).attr('id').split('_')[1]
                    $("#functionalType_" + id).empty()
                    $("#functionalType_" + id).append("<option></option>");
                    $("#functionalType_" + id).attr('disabled', true)
                    var functionalTypes = arr['pid' + $(this).val()]
                    if (typeof (functionalTypes) != 'undefined') {
                        $("#functionalType_" + id).attr('disabled', false)
                    }
                    for (var key in functionalTypes) {
                        $("#functionalType_" + id).append("<option value=" + functionalTypes[key][0] + ">" + functionalTypes[key][1] + "</option>");
                    }
                });
                $('#siteTable tbody').on('mouseenter', "select[name='realm_id']", function () {
                    if ($(this)[0].options.length < 2) {
                        var id = $(this).attr('id').split('_')[1]
                        if ($(this).val() > 0) {
                            $("#realm_" + id).prepend("<option></option>")
                        }
                        var realms = arr['pid0']
                        for (var key in realms) {
                            if ($(this).val() != realms[key][0]) {
                                $("#realm_" + id).append("<option value=" + realms[key][0] + ">" + realms[key][1] + "</option>");
                            }
                        }
                    }
                });
                $('#siteTable tbody').on('mouseenter ', "select[name='biome_id']", function () {
                    if ($(this)[0].options.length < 2) {
                        var id = $(this).attr('id').split('_')[1]
                        if ($('#realm_' + id).val() != 0) {
                            if ($(this).val() > 0) {
                                $("#biome_" + id).prepend("<option></option>")
                            }
                            var biomes = arr['pid' + $('#realm_' + id).val()]
                            for (var key in biomes) {
                                if ($(this).val() != biomes[key][0]) {
                                    $("#biome_" + id).append("<option value=" + biomes[key][0] + ">" + biomes[key][1] + "</option>");
                                }
                            }
                        }
                    }
                });
                $('#siteTable tbody').on('mouseenter ', "select[name='functional_type_id']", function () {
                    if ($(this)[0].options.length < 2) {
                        var id = $(this).attr('id').split('_')[1]
                        if ($('#biome_' + id).val() != 0) {
                            if ($(this).val() > 0) {
                                $("#functionalType_" + id).prepend("<option></option>")
                            }
                            var functionalTypes = arr['pid' + $('#biome_' + id).val()]
                            for (var key in functionalTypes) {
                                if ($(this).val() != functionalTypes[key][0]) {
                                    $("#functionalType_" + id).append("<option value=" + functionalTypes[key][0] + ">" + functionalTypes[key][1] + "</option>");
                                }
                            }
                        }
                    }
                });
                /* GADM */
                $('#siteTable tbody').on('change', "select[name='gadm0']", function () {
                    var id = $(this).attr('id').split('_')[1]
                    $("#gadm1_" + id).empty()
                    $("#gadm2_" + id).empty()
                    $("#gadm1_" + id).append("<option></option>");
                    $("#gadm2_" + id).append("<option></option>");
                    $("#gadm1_" + id).attr('disabled', true)
                    $("#gadm2_" + id).attr('disabled', true)
                    $.ajax({
                        url: "{{ baseUrl }}/admin/siteManager/gadm/1/" + $(this).val(),
                        success: function (data) {
                            if (data == '[]') {
                                $("#gadm1_" + id).attr('disabled', true)
                                $("#gadm2_" + id).attr('disabled', true)
                            } else if (typeof (data) != 'undefined') {
                                $("#gadm1_" + id).attr('disabled', false)
                                data = JSON.parse(data)
                                for (var key in data) {
                                    $("#gadm1_" + id).append("<option value=" + data[key]['name'] + ">" + data[key]['name'] + "</option>");
                                }
                            }
                        },
                    })
                });
                $('#siteTable tbody').on('change', "select[name='gadm1']", function () {
                    var id = $(this).attr('id').split('_')[1]
                    $("#gadm2_" + id).empty()
                    $("#gadm2_" + id).append("<option></option>");
                    $("#gadm2_" + id).attr('disabled', true)
                    $.ajax({
                        url: "{{ baseUrl }}/admin/siteManager/gadm/2/" + $(this).val(),
                        success: function (data) {
                            if (data == '[]') {
                                $("#gadm2_" + id).attr('disabled', true)
                            } else if (typeof (data) != 'undefined') {
                                $("#gadm2_" + id).attr('disabled', false)
                                data = JSON.parse(data)
                                for (var key in data) {
                                    $("#gadm2_" + id).append("<option value=" + data[key]['name'] + ">" + data[key]['name'] + "</option>");
                                }
                            }
                        },
                    })
                });
                $('#siteTable tbody').on('mouseenter ', "select[name='gadm0']", function () {
                    if ($(this)[0].options.length < 2) {
                        var id = $(this).attr('id').split('_')[1]
                        if ($('#gadm0_' + id).val() != '') {
                            $("#gadm0_" + id).prepend("<option></option>")
                        }
                        $.ajax({
                            url: "{{ baseUrl }}/admin/siteManager/gadm/0/0",
                            success: function (data) {
                                if (typeof (data) != 'undefined') {
                                    data = JSON.parse(data)
                                    for (var key in data) {
                                        if ($('#gadm0_' + id).val() != data[key]['name']) {
                                            $("#gadm0_" + id).append("<option value=" + data[key]['name'] + ">" + data[key]['name'] + "</option>");
                                        }
                                    }
                                }
                            },
                        })
                    }
                });
                $('#siteTable tbody').on('mouseenter ', "select[name='gadm1']", function () {
                    if ($(this)[0].options.length < 2) {
                        var id = $(this).attr('id').split('_')[1]
                        if ($('#gadm0_' + id).val() != '') {
                            if ($('#gadm1_' + id).val() != '') {
                                $("#gadm1_" + id).prepend("<option></option>")
                            }
                            $("#gadm1_" + id).attr('disabled', true)
                            $.ajax({
                                url: "{{ baseUrl }}/admin/siteManager/gadm/1/" + $('#gadm0_' + id).val(),
                                success: function (data) {
                                    if (typeof (data) != 'undefined' && data != '[]') {
                                        $("#gadm1_" + id).attr('disabled', false)
                                        data = JSON.parse(data)
                                        for (var key in data) {
                                            if ($('#gadm1_' + id).val() != data[key]['name']) {
                                                $("#gadm1_" + id).append("<option value=" + data[key]['name'] + ">" + data[key]['name'] + "</option>");
                                            }
                                        }
                                    }
                                },
                            })
                        }
                    }
                });
                $('#siteTable tbody').on('mouseenter ', "select[name='gadm2']", function () {
                    if ($(this)[0].options.length < 2) {
                        var id = $(this).attr('id').split('_')[1]
                        if ($('#gadm1_' + id).val() != '') {
                            if ($('#gadm2_' + id).val() != '') {
                                $("#gadm2_" + id).prepend("<option></option>")
                            }
                            $("#gadm2_" + id).attr('disabled', true)
                            $.ajax({
                                url: "{{ baseUrl }}/admin/siteManager/gadm/2/" + $('#gadm1_' + id).val(),
                                success: function (data) {
                                    if (typeof (data) != 'undefined' && data != '[]') {
                                        $("#gadm2_" + id).attr('disabled', false)
                                        data = JSON.parse(data)
                                        for (var key in data) {
                                            if ($('#gadm2_' + id).val() != data[key]['name']) {
                                                $("#gadm2_" + id).append("<option value=" + data[key]['name'] + ">" + data[key]['name'] + "</option>");
                                            }
                                        }
                                    }
                                },
                            })
                        }
                    }
                });
                $('#siteTable tbody').on('click', '.js-site-delete', function (e) {
                    if (!confirm('Are you sure you want to delete this site?')) {
                        return false;
                    }
                    deleteRequest('{{ baseUrl }}/api/admin/siteManager/delete/' + $(this).data('id'), [], false, false, function () {
                        location.reload();
                    });
                });
                $('#siteTable tbody').on('click', ".js-open-modal", function (e) {
                    let data = [];
                    if (this.dataset.id) {
                        data = {'id': this.dataset.id};
                    }
                    requestModal(this.href, data);
                    e.preventDefault();
                });

                $('#siteForm').submit(function (e) {
                    e.preventDefault();
                    $('#areaValid').text('')
                    $('#siteValid').text('')
                    if (this.checkValidity() === false) {
                        if (!($('#longitude').val() != '' && $('#latitude').val() != '') && $('#gadm0').val() == '') {
                            $('#areaValid').text('Please provide area or coordinates.')
                        }
                        e.stopPropagation();
                    } else {
                        if (!($('#longitude').val() != '' && $('#latitude').val() != '') && $('#gadm0').val() == '') {
                            $('#areaValid').text('Please provide area or coordinates.')
                            return
                        }
                        postRequest('{{ baseUrl }}/api/admin/siteManager/save', new FormData($(this)[0]), false, false, function (response) {
                            if (response.isValid) {
                                $('#siteValid').text(response.message)
                                return
                            }
                            location.reload();
                        });
                    }
                    this.classList.add('was-validated');
                });
                $('#projectId').change(function () {
                    $('#collectionId').val("")
                    $("#projectForm").submit();
                });
                $('#collectionId').change(function () {
                    $("#projectForm").submit();
                });

                /* Save site list */
                $('.js-site-list').on('change', 'input, select, textarea', function () {
                    var id = $(this).parent().parent().find('[name="name"]').attr('id');
                    $('#siteValid' + id).text('')
                    $('#areaValid' + id).text('')
                    console.log(id)
                    if (this.checkValidity() === false) { // this.style.border = "1px solid red";
                        let tdLongDiv = $(this).parent().children("div");
                        tdLongDiv.addClass("d-block");
                        if (!($('#longitude' + id).val() != '' && $('#latitude' + id).val() != '') && $('#gadm0_' + id).val() == '') {
                            $('#areaValid' + id).text('Please provide area or coordinates.')
                        }
                    } else {
                        let tdLongDiv = $(this).parent().children("div");
                        tdLongDiv.removeClass("d-block");
                        if (!($('#longitude' + id).val() != '' && $('#latitude' + id).val() != '') && $('#gadm0_' + id).val() == '') {
                            $('#areaValid' + id).text('Please provide area or coordinates.')
                            return
                        }
                        saveFormList($(this), 'api/admin/siteManager/save', function (response) {
                            if (response.isValid) {
                                $('#siteValid' + id).text(response.message)
                            }
                        });
                    }
                });

                $(document).on('click', '#saveButton', function () {
                    $('#siteEdit').submit();
                });
            });
        });
    </script>
{% endblock %}
